# AGENTS.md

This file defines the **working conventions for Codex (AI coding agents)**. All work must follow this document.

## Mandatory rules (highest priority)

- **All reviews, explanations, feedback, and PR-comment-style text must be written in Japanese** (keep code identifiers/comments consistent with existing style)
- **Codex review output is always in Japanese.**ã€€(Review text, summary, verification results, and concerns included)
- **Do not manually edit generated artifacts or build outputs**
  - `.open-next/` is generated by `opennextjs-cloudflare build`
  - `cloudflare-env.d.ts` is generated by `pnpm cf-typegen` (=`wrangler types`) and must not be edited manually
- **Respect the existing style**
  - This codebase uses tab indentation in many TS/TSX/config files. Do not introduce large formatting-only diffs
- **Do not add dependencies unnecessarily**
  - If adding a dependency is required, clearly explain the reason, alternatives, and impact scope first

## Assumed runtime / deployment target

- **Local development**: `next dev --turbopack` (on Node.js)
- **Production (and preview)**: Cloudflare Workers (`wrangler.jsonc` uses `main: .open-next/worker.js`)

Because of this, be careful when relying on Node-only APIs (e.g. `fs`) and confirm whether they work on Cloudflare.

## Project overview

This repository runs **Next.js (App Router)** on **Cloudflare Workers**. It uses `@opennextjs/cloudflare` (OpenNext) and is set up so local development can access Cloudflare bindings.

## Tech stack

- **Next.js**: `next@15.5.9` (App Router)
- **React**: `react@19.1.4`
- **TypeScript**: strict (`tsconfig.json` has `strict: true`)
- **Lint**: `eslint` + `eslint-config-next` (`next/core-web-vitals`, `next/typescript`)
- **CSS**: Tailwind CSS v4 (`@import "tailwindcss";`)
- **Cloudflare**: `wrangler@^4` / Workers runtime (`wrangler.jsonc`)
- **OpenNext**: `@opennextjs/cloudflare@^1.14.4`

## Key directories/files

- `src/app/`
  - `layout.tsx`: root layout (fonts / `globals.css`)
  - `page.tsx`: root page
  - `globals.css`: Tailwind import & theme variables
- `public/`: static assets
- `wrangler.jsonc`: Workers configuration (`main: .open-next/worker.js`, assets/images/service bindings, etc.)
- `open-next.config.ts`: OpenNext configuration (incremental cache can be configured here if needed)
- `next.config.ts`: calls `initOpenNextCloudflareForDev()` to enable Cloudflare context usage during `next dev`
- `cloudflare-env.d.ts`: Cloudflare bindings types (generated)

## Commands (must match package.json)

Scripts are defined in `package.json`. Prefer `pnpm` (because `pnpm-lock.yaml` exists).

- **Dev (Next dev)**: `pnpm dev`
- **Build (Next build)**: `pnpm build`
- **Start (Next start)**: `pnpm start`
- **Lint (all)**: `pnpm lint` (runs `lint:next` and `lint:biome`)
- **Lint (Next)**: `pnpm lint:next`
- **Lint (Biome)**: `pnpm lint:biome`
- **Fix (all)**: `pnpm fix` (runs `fix:biome`)
- **Fix (Biome)**: `pnpm fix:biome`
- **Cloudflare preview (local on Workers runtime)**: `pnpm preview`
  - `opennextjs-cloudflare build && opennextjs-cloudflare preview`
- **Deploy**: `pnpm deploy`
  - `opennextjs-cloudflare build && opennextjs-cloudflare deploy`
- **Upload**: `pnpm upload`
  - `opennextjs-cloudflare build && opennextjs-cloudflare upload`
- **Type generation (Cloudflare bindings)**: `pnpm cf-typegen`
  - Output file: `./cloudflare-env.d.ts` (do not edit manually)
- **Dead code check**: `pnpm knip`

## Cloudflare / OpenNext assumptions (important)

- `wrangler.jsonc` sets the Worker entry to `.open-next/worker.js` (exists after build)
- Assets use `.open-next/assets` via the `ASSETS` binding
- Images use the `IMAGES` binding (used for Next Image optimization)
- `WORKER_SELF_REFERENCE` is a self-referencing service binding (Fetcher)
- `NEXTJS_ENV` exists in Env (typed in `cloudflare-env.d.ts`)

### Cloudflare bindings (based on current type definitions)

`Cloudflare.Env` in `cloudflare-env.d.ts` includes at least:

- `ASSETS`: Fetcher
- `IMAGES`: ImagesBinding
- `WORKER_SELF_REFERENCE`: Fetcher
- `NEXTJS_ENV`: string

If you add/remove bindings, update **both** `wrangler.jsonc` and the generated types (`pnpm cf-typegen`).

## Typical workflow (Codex)

- **Understand requirements**: summarize goals/acceptance criteria/scope briefly (in Japanese)
- **Minimal changes**: keep the scope tight; avoid unrelated formatting or dependency churn
- **Implement**: follow App Router conventions (Server/Client component boundaries)
- **Self-check**:
  - `pnpm lint`
  - When relevant, verify locally with `pnpm dev` (consider `pnpm preview` for larger changes)

## Implementation guidelines

- **App Router**: files under `src/app` are Server Components by default; add `"use client"` only when needed
- **Type safety**: avoid introducing `any`; prefer types/generics/utility types
- **Imports**: path alias `@/*` maps to `./src/*` (`tsconfig.json`)
- **Styling**: prefer Tailwind; keep consistency with theme variables in `globals.css` (e.g. `--background`)
- **Minimize diffs**: follow existing structure, naming, and indentation; avoid unrelated formatting changes

### Notes for Next.js / App Router

- `next/image` behavior is tied to Cloudflare `IMAGES`; be mindful of preview/runtime compatibility when changing images
- `initOpenNextCloudflareForDev()` in `next.config.ts` enables Cloudflare context access during dev; do not remove without a reason

## Change safety (avoid pitfalls)

- Do not edit `.open-next/` directly (it is generated; fix source/config and rebuild)
- Do not edit `cloudflare-env.d.ts` directly (regenerate via `pnpm cf-typegen`)
- Do not touch `node_modules/`
- Keep dependency changes minimal; if updating `pnpm-lock.yaml` is required, explain why

## Definition of done

- The implementation meets the goal and `pnpm lint` has no critical issues
- Cloudflare assumptions (deploy/preview) are not broken
- The change summary/review is written concisely in **Japanese**

## Review output format (for Codex)

- **In Japanese**: briefly cover reason, scope, verification steps, and concerns
- **Minimal code quoting**: quote only the most important diffs
- **State uncertainty**: if you did not run something, say so and include verification steps
